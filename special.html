<!DOCTYPE html>
<html>

  <head>
    <script type="text/javascript"
            src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Dynaphopy : Phonon Analysis from Dynamical Data">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Dynaphopy</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <h2 id="project_tagline">Advanced options</h2>

        </header>
    </div>
    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
    	<section id="main_content" class="inner">

<a href="index.html"><div id="backbutton" s style="position:relative;right:-580px;top:-170px;width:60px"><body>Back</body></div></a>

<h3>Big data</h3>
<p>
In order to obtain well converged results in the calculation of anharmonic phonon properties, specially in phonon linewidths, 
usually it becomes necessary to use very long MD simulations. This requires long calculation times and imply to hadle very large 
files. Fortunatelly, in canonical ensemble calculations the velocity time correlation usually decreases fast with the time. That means that
it becomes possible to join several independent MD trajectories to obtain a larger one with almost negligible added error. That allows to
calculate many independent MD simulations at the same time and join them later to obtain a larger MD trajectory and increase the accuracy of
the results.
<br>To support this task DynaPhoPy can save the MD information into a hdf5 file to be read afterwards. Additionally I provide an independent
script called <strong>concath5</strong> which allows join several hdf5 files into one.
<br><em>Note: VASP code has to be compiled with advanced features in order to start MD from a random seed and generate different trajectories each run. Please, refere to VASP <a href="http://cms.mpi.univie.ac.at/vasp/vasp/Advanced_MD_techniques.html">documentation</a> 
for further information.</em></p>
<UL>

 


<LI><h5>Save data into hdf5 file </h5>
<p>Saving data into hdf5 file can be usefull in order to save space in the hard drive. Since only the necessary information for dynaphopy
is stored, this hdf5 file size can be around 5 times smaller than the original MD TRAJECTORY file. Besides it allows to manipulate this information as
an intermediate step using concath5 or other third party software. To request to save MD trajectory into hdf5 file use 
<strong>-sv</strong> flag follower by the file name. 
<br>This option can be used alone  or together with other flags but, in any case, all time steps in TRAJECTORY file will be stored in the hdf5 file (<strong>-n</strong> 
flag has no effect in the number of time steps stored).</p>

<pre><code>$ dynaphopy input_file TRAJECTORY -sv filename.h5
</code></pre>

<LI><h5>Load data into hdf5 file </h5>
<p> Once saved into a hdf5 file, MD data can be load to dynaphopy using <strong>-lv</strong> flag. Loading data from hdf5 is much faster
than using TRAJECTORY file, if several calculation using the same data have to be done, it is highly recomended to use this option.
than using TRAJECTORY file, if several calculation using the same data have to be done, it is highly recomended to use this option.
<br><em>Notice that when loading data this way, TRAJECTORY must not not be set.</em></p>

<pre><code>$ dynaphopy input_file -lv filename.h5
</code></pre>

<LI><h5>Manipulating data</h5>
<p>
The structure of the hdf5 file is quite simple. With a minimum knowledge of programming it can be easly manipulated by third parties software.
In dynaphopy script directory a simple script for joining data is provided named <strong>concath5</strong>. It can be used as example 
for more complex ones. To use this script just call it followed by the name of all the hdf5 files to be joined and the last one 
the name of the new hdf5 file that will contain all the joined data. 
</p>
<pre><code>$ concath5 source1.h5 source2.h5 source3.h5 ··· joined.h5
</code></pre>
<p>
By default <strong>concath5</strong> skips the first 20000 time steps of each source MD trajectory. This is done to ensure that the MD
is totally converged in each file. Using <strong>-f</strong> flag, is possible to define the number of time steps to be skipped.
</p>

<pre><code>$ concath5 source1.h5 source2.h5 ··· joined.h5
</code></pre>

<p>
Depending on the processed MD simulation the size of the resulting hdf5 file could be huge. In the lastest version, by default 
concath5 stores all the velocity  as well as the trajectory coordinates at each timestep. To calculate the phonon related
properties using DynPhoPy only the velocity is needed. So if no atomic displacement calculation is needed option <nobr><strong>--velocity_only</strong></nobr>
can be used. This option makes concath5 script to not store the trajectory in the final hdf5 file saving HD space.
</p>
<pre><code>$ concath5 --velocity_only source1.h5 source2.h5 ··· joined.h5
</code></pre>

<LI><h5>Working with wave-vector projected velocity (Saving RAM memory)</h5>
<p>The amount of physical RAM memory available may strongly limit the size of the trajectory that DyanPhopy can read. Specially for LAMMPS trajectories, whose output files can weight a few tens of Gb for long MD simulations, the memory can become easily full. This is usually no due to the trajectory size itself but the process of it that DynaPhoPy does. 
<br>To overcome this problem the trajectory can be read by pieces, projected into a wave vector, stored in the disk (hdf5 files), joined and read with DynaPhoPy again to calculate the power spectrum and the phonon properties. 
<br>Due to the dimensionality of the projected velocity is much lower than the original trajectory the, MD length that can be used is much longer. However, since the velocity is already projected, it only can be used to analyze the phonons in the projected wave vector. That means that for each wave vector to be analyzed this procedure has to be repeated.
<br><strong>Read data in pieces</strong>
<br>There are to flags to control the piece of data that DynaPhoPy will read. <strong>--read_from</strong> and <strong>--read_to</strong>. Each flag accept only one integer number each and define the interval of data to be read from the output file.
 
<pre><code>$ dynaphopy input_file OUT.lammpstrj --read_from 10000 --read_to 20000
</code></pre>
<p>This reads the trajectory in OUT.lammpstrj file from the 10000th until 20000th time step.
<br>To store the wave vector projected velocity into a file the <strong>-svc</strong> flag is used.  
<pre><code>$ dynaphopy input_file OUT.lammpstrj -svc projected_velocity.h5
</code></pre>
<p>Combining these three flags we can divide a long MD trajectory into smaller wave projected velocity files. These files can be joint using the concath5 script in the save way shown before.

<pre><code>$ concath5 proj_vel1.h5 proj_vel2.h5 ··· proj_vel_joined.h5
</code></pre>
<p>In this case <strong>-f</strong> flag should not be since those files are part of the same trajectory and we want the files to match exactly.
<br> Once joined, the combined proj_vel_joined.h5 file can be read by DynaPhoPy using <strong>-lv</strong> flag.</p>
<pre><code>$ dynaphopy input_file -lv projected_velocity.h5
</code></pre>

<br><em>It has to be pointed that when reading proj_vel_joined.h5 file the wave vector <strong>must not</strong> to be set. Wave vector is already stored in proj_vel_joined.h5 file. Defining another wave vector using <strong>-q</strong> flag will make DynaPhoPy to stop. Keep in mind that the number of features available reading from a projected velocity file are limited to <strong>power spectrum calculations and peak analysis</strong></em>

<LI><h5>Mapping RAM memory on disk (Saving RAM memory in exchange of storage space)</h5>
    <p>Alterativelly to divide the MD data into small pieces DynaPhoPy allows to map most part of the RAM memory on disk. This option allow us to work normally with dynaphopy without any pre processing of the data. To activate memory mapping use <strong>--memmap</strong>. This option requieres to define explicitily the amount of data to be loaded by options <strong>--read_from</strong> and <strong>--read_to</strong>
<pre><code>$ dynaphopy input_file TRAJECTORY --read_to 100000 --memmap
</code></pre>
    <p>Memory will be mapped in up to 4 files stored by default in the working directory. These files will be removed once the execution is finished (if DynaPhoPy crashed these files may not be removed). Environment variable <strong>DYNAPHOPY_TEMPDIR</strong> can be set to define an alternative location for these temporal files.
<pre><code>export DYNAPHOPY_TEMPDIR=/scratch</code></pre>
    <p>When working with LAMMPS MD trajectories, this procedure can be done more efficently reading the atomic velocities directly from LAMMPS output file instead to calculate them from the atomic positions (check <a href="usage.html#prepare_MD">prepare MD</a> section for more information about how to generate a LAMMPS output). This reduces the amount of RAM memmory to be used during the calculation and therefore the amount of storage space when using <strong>--memmap</strong> option.


<p><em>Warning: Using memory mapping will decrease the performance of the calculation and the i/o disk access will be intensive. It is recommended to use a local SSD disk for this purpose.</em>
</p>

    </UL>


<h3>MEM coeficient analysis</h3>
<p>
The correct setting of the number of coefficents in MEM algorithm to calculate the power spectrum is one of the crucial point to take in account.
Depending on the number of coefficents the peak width of the peaks may significantly change, which directly affects the phonon linewidths results.
<br>From my experience, if the MD simulations are long enough, as the number of coefficents increase the peak width become to stabilize while keeping the peaks shape smooth. Is to be expected than this stabilized width is more reliable even if the peaks become a little more uglyer.
<br>In order to check the evolution of the power spectra peaks width with the number of coefficents dynaphopy provides option <strong>-csa</strong>
which performs a scan for all peaks anf fits each one to Lorentzian function to extract width information.
All this information is plotted in 3 matplotlib windows for each phonon. 
</p>
<pre><code>$ dynaphopy input_file TRAJECTORY -csa
</code></pre>

<img src="images/coef_ana_2.png" alt="Interactive" style="width:605px">
<img src="images/coef_ana_1.png" alt="Interactive" style="width:605px">
<img src="images/coef_ana_3.png" alt="Interactive" style="width:605px">

<p>Additionally, it shows the optimum number of coeficients that has the best
fit with a Lorentzian function and estimates the peak width value taking a average for all coefficents ponderated by the inverse of fit error.</p>

<pre><code>Peak # 5
------------------------------------
Estimated width(FWHM): 0.0570242354113 THz
Position: 3.8546680966 THz
Optimum coefficients num: 336.0
Fitting Error: 2.31991499922e-07
</pre></code>

<h3>External power spectra analysis</h3>
<p>
The calculation of the power spectra, specially using Fourier transform method, can take a lot of time (maybe few days). For this reason the
calculation of these spectra may be done in a cluster computer in which may not have acces through graphical interface. This makes the fitting
analysis difficult since there is no way to evaluate visually if the fitting has been correctly done. Besides, the power spectrum obtained may
be noisy and a post processing may be needed to improve the fitting quality.
<br>In dynaphopy package, <strong>fitdata</strong> script is included in scripts folder to extract the anharmonic information from a power 
spectrum file obtained with Dynaphopy throught <strong>-sw</strong> or <strong>-sp</strong> options. This allows to first calculate the 
power spectrum using Dynaphopy in a cluster computer, saving it in a file and later extract the information in a local machine.
Additionally this script allows to smooth the spectrum using <a href="http://en.wikipedia.org/wiki/Local_regression">Local regression</a> method before fitting it with a Lorentzian function.
<br>During the execution it shows the smoothing result and the fitting result for each spectrum present in the spectrum file allowing to test
different smoothing parameters to obtain the best results.
</p>
<UL>
<LI><h5>Simple execution</h5>
<p> By default the script takes all the spectra present in the file and fits them to a Lorentzian function (equivalent to Dynaphopy peak analysis).
</p>
<pre><code>$ fitdata file
</code></pre>
<img src="images/fitting.png" alt="Interactive" style="width:605px">

<LI><h5>Smoothing spectra using local regression method</h5>
<p>This method works very well removing the noise in very noisy spectra. This allows to obtain much better results in the fitting and, in many cases, it becomes indispensable in order to get a meaningful result. To do this, the visual analysis becomes crucial to compare the original noisy spectrum and the smoothed one to make sure that the essetial peak shape is kept. To request the smooth methos use <strong>-sm</strong> flag.
</p>
<pre><code>$ fitdata -sm file
</code></pre>

<img src="images/smooth.png" alt="Interactive" style="width:605px">
<img src="images/fit_smooth.png" alt="Interactive" style="width:605px">
<LI><h5>Changing smoothing parameters</h5>
<p> In case that the smoothing process is not succesfull, it can be ajusted via smoothing span parameter <strong>-f</strong> (Default: 0.2). Increasing its value will make the strectra smoother but may differ more from the original spectrum. 
</p>
<pre><code>$ fitdata -sm -f 0.4 file
</code></pre>

<LI><h5>Combining spectra</h5>
<p> In high symmetry points in the reciprocal space (wave vector), it may happen that two or more phonon are degenerated. In that case the projection into this wave vector and, consecutively, the power spectra should present the same properties (Width and position). In order to
increase the fitting precision these equivalent spectra can be conbined into one reducing the random error. This can be done using <strong>-bi</strong> flag. Following this flag it is nedeed to introduce a string containing the number of the spectra to be combined (equivalent spectra) separated by spaces and the non equivalent spectra separated by comma like in the following example:
</p>
<pre><code>$ fitdata -bi "1 2, 3 4 5" file
</code></pre>

<p> in this example, the script will fit two phonon power spectra. The first one using the avarage of the spectra 1 and 2. The second one
using the average of spectra 3, 4 and 5.
</p>

</UL>
<div id="qha"></div> 
<h3>Thermal expansion contribution</h3>
<p>
Thermal expansion may have a huge contribution to the frequency shift at high temperatures. This contribution can be included in DynaPhoPy via force constants. These force constants are obtained from a lattice dynamics calculation using a unit cell correspoponding to the cell volume at a given temperature. This temperature should correspond to the temperature at which the MD simulation is calculated. The crystal symmetry of the unit cell is assumed to remain constant with the volume. If the crystal symmetry of the structure at the analyzed temperature is different respect the symmetry of the structure at 0 K temperature this approximation may be incorrect.
<BR>In order to calculate the thermal expansion contribution the quasi-harmonic approximation (QHA) may be used. DynaPhoPy package includes a script to facilitate this calculation using phonopy: <strong>qha_extract</strong>.
To use this script, first it is necessary to prepare a set of phonon calculations at different volumes as described in <a href="https://atztogo.github.io/phonopy/qha.html#id1.">phonopy-qha manual</a>. Using this procedure we should obtain 3 kinds of files:
<BR> 1) A FORCE_CONSTANTS file at each volume.
<BR> 2) A thermal_properties.yaml file at each volume
<BR> 3) A e-v.dat file.

<BR> The <strong>qha_extract</strong> is executed by:
</p>
<p>
<pre><code>$ qha_extract input_file -ev e-v.dat 
-fc FORCE_CONSTANTS_1 FORCE_CONSTANTS_2 FORCE_CONSTANTS_3 ...  
-tp thermal_properties_1.yaml thermal_properties_2.yaml ...
-t 800
</code></pre>
</p>
 <p>where <em>input_file</em> is a usual DynaPhoPy input file (the same used to analyze the MD is OK) and <strong>-t</strong> flag indicates the temperature at which the force constants are obtained. This temperature should be the one at which the MD simulation is calculated. The output result of this script is a file named <em>FORCE_CONSTANTS_QHA</em> that contains the force constants at the given temperature.

<BR>The order in which the files are introduced using <strong>-fc</strong> and <strong>-tp</strong> flags matters, make sure to be consistent each other. Wildcards can be used, just make sure the filenames is properly set according to alphanumeric order:
</p>
<p>
<pre><code>$ qha_extract input_file -ev e-v.dat 
-fc FORCE_CONSTANTS_*  
-tp thermal_properties_*
-t 800
</code></pre>
</p>
<p>Optional flags:  
    <BR><strong>-p</strong> Plot results of the QHA calculation using phonopy-qha
        <BR><strong>-sfc</strong> Defines custom name for the ouput <em>FORCE_CONSTANTS_QHA</em> file.
</p>
<p>Once the calculation is finished, the file <em>FORCE_CONSTANTS_QHA</em> is used in DynaPhoPy by the flag <strong>--qha_force_constants</strong>:  
</p>
<p>
<pre><code>$ dynaphopy input_file TRAJECTORY 
--qha_force_constants FORCE_CONSTANTS_QHA
</code></pre>
</p>

    </section>
    </div>
    
    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Dynaphopy maintained by <a href="https://github.com/abelcarreras">abelcarreras</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>
    
  </body>
</html>